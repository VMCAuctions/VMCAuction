<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>
            Clerk Check In
        </title>
        <!-- pdfmake scripts -->
        <script src='/pdfmake/pdfmake.js'></script>
        <script src='/pdfmake/vfs_fonts.js'></script>
        <!-- jquery -->
        <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
        <!-- sockets -->
        <script src="/socket.io/socket.io.js"></script>

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" type="text/css" href="/css/clerkDash.css">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
            crossorigin="anonymous">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>  
    </head>
    <body>
		<%- include('clerkHeader') -%>
		<div id="buttons">
			<div class="">
				<button type="button" id="checkinButton"  class="btn btn-add mb-4">Check in</button>
				<button type="button" id="checkOutButton" class="btn btn-add mb-4">Check out</button>
				<button type="button" id="retrieveButton" class="btn btn-add mb-4">Retrieve won packages</button>
			</div>
		</div>
		<div class="container-fluid">
			<div id="clerkSearch" class="row">
				<!-- Find supporters by last name -->
				<div id="search-lastName" class="col-4">
					<label for "lastName" class="label-search">Search by Last Name</label>
					<input class="form-control" type="search" id="lastName" placeholder="Last Name">
				</div>
				<!-- Find package by package name -->
				<div id="search-packageName" class="col-4">
					<label for "packageName" class="label-search">Search by Package Name</label>
					<input class="form-control" type="search" id="packageName" placeholder="Package Name">
				</div>
			</div>
				
			<!-- Search for Supporters-->
			<div id="supporterTable">
				<h3>Supporters</h3>
				<table class="table table-striped table-bordered package-table">
					<thead>
						<tr>
							<th scope="col">First Name</th>
							<th scope="col">Last Name</th>
							<th scope="col">Packages Won</th>
							<th scope="col">Total Bid</th>
							<th scope="col">Invoice</th>
						</tr>
					</thead>
					<tbody id="carts">
						<% for (var u in users) {%>
							<tr class="supporterRow">
								<td><a href="/<%=auction._id%>/clerkDash"><%= users[u].firstName %></a></td>
								<td id='supporterLast'><a href="/<%=auction._id%>/clerkDash"> <%= users[u].lastName %> </a></td>
								<td id="<%= users[u].userName + 'winning' %>">
									<ul>
										<% for (var p in cart[users[u].userName].packages) { %>
											<li><%= cart[users[u].userName].packages[p]._id %>. <%= cart[users[u].userName].packages[p].name %>
												$<%= cart[users[u].userName].packages[p].bids[cart[users[u].userName].packages[p].bids.length - 1].bidAmount %></li>
										<% } %>
									</ul>
								</td>
								<td id="<%= users[u].userName + 'total' %>">
									$<%= cart[users[u].userName].total %>
								</td>
								<td>
									<button type="button" class="pdfBut" data-first="<%- users[u].firstName %>" data-last="<%- users[u].lastName %>" data-user="<%- users[u].userName %>">Invoice</button>
								</td>
							</tr>
						<% } %>
					</tbody>
				</table>
			</div>
			<!-- for Package name -->
			<div id="packageTable">
					<h3>Packages</h3>
					<table class="table table-striped table-bordered package-table">
						<thead>
							<tr>
								<th scope="col">Package Id</th>
								<th scope="col">Image</th>
								<th scope="col">Package Name</th>
								<th scope="col">Winning Bidder</th>
								<th scope="col">Winning Bid</th>
							</tr>
						</thead>
						<tbody id="carts">
							<% for (var i in packages) {%>
								<tr class="packageRow">
									<td><%= packages[i]._id%></td>
									<td> <img src="/<%= packages[i].photo%>" alt=""> </td>
									<td><a href="/<%=auction%>/packages/<%=packages[i]._id%>"><%=packages[i].name%></a></td>
									<td><%= packages[i].highBidder%></td>
									<td><%= packages[i].highBid%></td>
								</tr>
							<% } %>
						</tbody>
					</table>
				</div>

		</div>
		<!-- json parse scripts -->
		<script type="text/javascript">
			var cart = <%-JSON.stringify(cart)%>;
			var packages = <%-JSON.stringify(packages)%>;
		</script>

		<!-- search box scripts -->
		<script type="text/javascript">
			$(document).ready(function () {
				console.log("100 clerkCheckOut-shell.js script document.ready start");
				
				$("#clerkSearch").show();
				$("#supporterTable").hide();
				$("#packageTable").hide();

				$("#lastName").on("keyup", function () {
					var value = $(this).val().toLowerCase();
					if (value == '') {
						$("#supporterTable").hide();
					} else {
						$("#supporterTable").show();
						$(".supporterRow").filter(function () {
							$(this).toggle($(this).text().toLowerCase().indexOf(value) > 0);
						});
					};
				});
				
				$("#packageName").on("keyup", function () {
					var value = $(this).val().toLowerCase();
					if (value == '') {
						// $(".packageRow").show();
						$("#packageTable").hide();
					} else {
						$("#packageTable").show();
						$(".packageRow").filter(function () {
							$(this).toggle($(this).text().toLowerCase().indexOf(value) > 0);
						});
					};
				});
			})
		</script>
		<script type="text/javascript">
			$(".pdfBut").click(function(){
				var firstName = $(this).data('first')
				var lastName = $(this).data('last')
				var userName = $(this).data('user')
				var newCart = cart

				function buildTable(crt) {
					tableData = []
					columns = ['_id','name','description','bids']
					tableData.push(['Package ID','Package Name','Package Description','Winning Bid Amount'])
					crt.forEach(function(row) {
						var rowData = []
						for(var x = 0; x < columns.length; x++) {
							if(x == columns.length - 1) {
								tmpBids = row.bids
								winBid = tmpBids[tmpBids.length - 1]
								winAmt = winBid.bidAmount
								rowData.push(winAmt)
							} else {
								rowData.push(row[columns[x]])
							}
						}
						tableData.push(rowData)
					})
					return tableData
				}
				docDef = {
					content: [
					{ text: firstName + ' ' + lastName, style: 'header'},
					{
						table: {
							headerRows: 1,
							body: buildTable(newCart[userName].packages)
						}
					}
					],
					styles: {
						header: {
							fontSize: 22,
							bold: true
						}
					}
				}
				pdfMake.createPdf(docDef).open()
			})
		</script>
        
  
    </body>
</html>
