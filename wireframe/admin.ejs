<!DOCTYPE html>
<html>
<head>
    <title>
        Admin Panel
    </title>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <%- include('admin_header') -%>


    <!-- check with client to verify all admin powers / priveledges, regarding deleting and editing other non admin users -->


  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th scope="col">Users</th>
        <th scope="col">Admin Status</th>
        <!-- <th scope="col">Packages Watched</th> -->
        <th scope="col">Packages Winning</th>
        <th scope="col">Total Spent</th>
      </tr>
    </thead>
    <tbody>
    <form class="" action="/users/admin_change" id="ourForm" method="post">
      <% var superAdmin = false%>

      <% if (userName == "admin"){%>
        <%superAdmin = true%>
      <%}%>

      <% for (var u in users) {%>
        <tr>
          <td><a href="/api/users/<%= users[u].userName %>"><%= users[u].userName %></a></td>
          <td>
            <%if (superAdmin){%>
              <%if (users[u].userName == "admin"){%>
                <p><%=users[u].admin%></p>

              <%}else{%>
                <select name = "<%=users[u]._id%>">
                    <option value = "<%=users[u].admin%>">
                      <%=users[u].admin%>
                    </option>
                    <option value = "<%=!users[u].admin%>">
                      <%=!users[u].admin%>
                    </option>
                </select>
              <%}%>

            <%}else{%>
              <p><%=users[u].admin%></p>
            <%}%>

          </td>
          <!-- <td><%=users[u]._packages.length%></td> -->
          <td id="<%=users[u].userName + 'winning'%>"><%=cart[users[u].userName].packages.length%></td>
          <td id="<%=users[u].userName + 'total'%>">$<%=cart[users[u].userName].total%></td>
        </tr>
      <%}%>

        </tbody>
      </table>
      <input type='submit' value='Save'>
    </form>
    <script>
      var cart = <%-JSON.stringify(cart)%>;
      var packages = <%-JSON.stringify(packages)%>;

    	var socket = io.connect('http://localhost:8000/');
      socket.on("serverTalksBack", function(data){
        // console.log("coming in");
        console.log('cart before', cart);
        var winningAlready = false
        console.log('1', winningAlready);
        for (var i = 0; i < cart[data.userName].packages.length; i++) {
          // console.log("data", data.packId);
          // console.log("cart", cart[data.userName].packages[i]._id);
          console.log(data.packId);
          console.log(cart[data.userName].packages[i]);
          if (data.packId == cart[data.userName].packages[i]._id) {
            // console.log("reache if");
            cart[data.userName].total-=cart[data.userName].packages[i].bids[cart[data.userName].packages[i].bids.length-1].bidAmount
            winningAlready = true
            // console.log(cart[data.userName].total);
            break
          }
        }
        console.log('who data', data.userName);
        console.log('2', winningAlready);
        if (!winningAlready) {
          console.log('will bw winning', data.userName);
          $('#'+data.userName+'winning').text(parseInt($('#'+data.userName+'winning').text())+1)
          console.log('winning now', data.userName);
          for (var i = 0; i < packages.length; i++) {
            if (data.packId == packages[i]._id) {
              cart[packages[i].bids[packages[i].bids.length-1].name].total -=packages[i].bids[packages[i].bids.length-1].bidAmount;
              console.log('before', cart[packages[i].bids[packages[i].bids.length-1].name].packages);
              var lost = cart[packages[i].bids[packages[i].bids.length-1].name].packages.indexOf(packages[i]);
              cart[packages[i].bids[packages[i].bids.length-1].name].packages.splice(lost, 1)
              console.log('after', cart[packages[i].bids[packages[i].bids.length-1].name].packages);
              console.log('was winning', packages[i].bids[packages[i].bids.length-1].name);
              $('#'+packages[i].bids[packages[i].bids.length-1].name+'winning').text(parseInt($('#'+packages[i].bids[packages[i].bids.length-1].name+'winning').text())-1)
              console.log('no longer winning', packages[i].bids[packages[i].bids.length-1].name);
              $('#'+packages[i].bids[packages[i].bids.length-1].name+'total').text("$" + cart[packages[i].bids[packages[i].bids.length-1].name].total);
              packages[i].bids.push({bidAmount: data.bid, name: data.userName})
              cart[data.userName].packages.push(packages[i])
            }
          }
        }
        cart[data.userName].total+=data.bid
        $('#'+data.userName+'total').text("$" + cart[data.userName].total);
        console.log('cart after', cart);
      })
    </script>
  </body>
</html>
