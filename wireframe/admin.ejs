<!DOCTYPE html>
<html>
<head>
    <title>
        Admin Panel
    </title>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <%- include('admin_header') -%>


    <!-- check with client to verify all admin powers / priveledges, regarding deleting and editing other non admin users -->


  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th scope="col">Users</th>
        <th scope="col">Admin Status</th>
        <th scope="col">Packages Watched</th>
        <th scope="col">Packages Winning</th>
        <th scope="col">Total Spent</th>
      </tr>
    </thead>
    <tbody>
    <form class="" action="/users/admin_change" id="ourForm" method="post">
      <% var superAdmin = false%>

      <% if (userName == "admin"){%>
        <%superAdmin = true%>
      <%}%>

      <% for (var u in users) {%>
        <tr>
          <td><a href="/api/users/<%= users[u].userName %>"><%= users[u].userName %></a></td>
          <td>
            <%if (superAdmin){%>
              <%if (users[u].userName == "admin"){%>
                <p><%=users[u].admin%></p>

              <%}else{%>
                <select name = "<%=users[u]._id%>">
                    <option value = "<%=users[u].admin%>">
                      <%=users[u].admin%>
                    </option>
                    <option value = "<%=!users[u].admin%>">
                      <%=!users[u].admin%>
                    </option>
                </select>
              <%}%>

            <%}else{%>
              <p><%=users[u].admin%></p>
            <%}%>

          </td>
          <td><%=users[u]._packages.length%></td>
          <td id="<%=users[u].userName + 'winning'%>"><%=cart[users[u].userName].packages.length%></td>
          <td id="<%=users[u].userName + 'total'%>">$<%=cart[users[u].userName].total%></td>
        </tr>
      <%}%>

        </tbody>
      </table>
      <input type='submit' value='Save'>
    </form>
    <script>
    	var socket = io.connect('https://114ba923.ngrok.io');
      socket.on("serverTalksBack", function(data){
        // console.log("coming in");
        var cart = <%-JSON.stringify(cart)%>;
        for (var i = 0; i < cart[data.userName].packages.length; i++) {
          // console.log("data", data.packId);
          // console.log("cart", cart[data.userName].packages[i]._id);
          if (data.packId == cart[data.userName].packages[i]._id) {
            // console.log("reache if");
            cart[data.userName].total-=cart[data.userName].packages[i].bids[cart[data.userName].packages[i].bids.length-1].bidAmount
            cart[data.userName].total+=data.bid
            // console.log(cart[data.userName].total);
            $('#'+data.userName+'total').text("$" + cart[data.userName].total)
            break
          }
          //we need to finish the for loop. then if it never matched anything in cart we need to just add
          //and add following code. then write code for only increasing the cart.
          // $('#'+data.userName+'winning').text(parseInt($('#'+data.userName+'winning').text())+1)
        }
      })
    </script>
  </body>
</html>
