<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
	<title>Package Show</title>
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<link rel="stylesheet" href="http://cdn.dhtmlx.com/edge/dhtmlx.css" type="text/css"> 
	<link rel="stylesheet" type="text/css" href="/css/packageRegister.css">
	<link rel="stylesheet" type="text/css" href="/css/packageUprights.css">
	<script src="https://code.jquery.com/jquery-3.4.0.min.js" integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg=" crossorigin="anonymous"></script> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
	<script src="http://cdn.dhtmlx.com/edge/dhtmlx.js" type="text/javascript"></script>
	<style>

		.upright {
			width: 400px;
			height: 518px;
			text-align: center;
			background: rgb(32, 108, 194);
			color: #fff;
			padding: 15px 0px;
		}

		.donor, .packageId, .value, #fitin {
			background: black;
			position: relative;
		}

		.donor {
			width: 100%;
			height: 8%;
			font-size: 12px;
			padding: 1% 0px;
		}

		.resized-text {
			width: 90%;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}

		.title {
			width: 100%;
			height: 9%;
			font-size: 60px;
			position: relative;
			margin: 2% 0px;
			font-weight: bold;
			letter-spacing: 0.5px;
		}

		.image {
			width: 100%;
			height: 40%;
			margin-bottom: 5%;
			font-size: 14px;
		}

		.flexible-photo {
			max-width: 90%;
			max-height: 100%;
			border: 5px solid black;
		}

		.packageId {
			bottom: 93%;
			width: 30%;
			text-align: right;
			padding: 1% 4% 1% 0px;
		}

		.value {
			bottom: 36.5%;
			left: 70%;
			width: 30%;
			text-align: left;
			padding-left: 5%;
			padding: 1% 0px 1% 4%;
		}

		#fitin {
			font-size: 20px;
			width: 100%;
			height: 35%;
			padding: 3% 0px;
		}
	</style> 

	<script>
		// handles font re-sizing
		$(function() {
			$('#fitin div').css('font-size', '1em');
			
			while( $('#fitin div').height() > $('#fitin').height() ) {
				$('#fitin div').css('font-size', (parseInt($('#fitin div').css('font-size')) - 1) + "px" );
			}

			$('.donor div').css('font-size', '1em');
			
			while( $('.donor div').height() > $('.donor').height() ) {
				$('.donor div').css('font-size', (parseInt($('.donor div').css('font-size')) - 1) + "px" );
			}

			$('.title div').css('font-size', '1em');
			
			while( $('.title div').height() > $('.title').height() ) {
				$('.title div').css('font-size', (parseInt($('.title div').css('font-size')) - 1) + "px" );
			}
			
		});

		function retrieveData(x) {
			var upright = document.getElementsByClassName("form")[0];
			upright.classList.remove("hidden");

			// creates upright from getting data from the table
			var index = x.rowIndex;
			var id = document.getElementById("tableRow").rows[index].cells[0].innerHTML;
			var packageId = document.getElementById("packageId");

			var photo = document.getElementById("tableRow").rows[index].cells[4].innerHTML;
			var photoBox = document.getElementById("photoBorder");

			var title = document.getElementById("tableRow").rows[index].cells[1].innerHTML;
			var titleBox = document.getElementsByClassName("resized-text")[1];

			var value = document.getElementById("tableRow").rows[index].cells[5].innerHTML;
			var valueBox = document.getElementsByClassName("value")[0];

			var desc = document.getElementById("tableRow").rows[index].cells[6].innerHTML;
			var descBox = document.getElementsByClassName("resized-text")[2];

			packageId.textContent = "#" + id;
			photoBox.src = `/${photo}`
			titleBox.innerHTML = title;
			valueBox.innerHTML = `Value: ${value}`;
			descBox.innerHTML = desc;

			// highlights selected table row
			var rowsNotSelected = tableRow.getElementsByTagName('tr');
			for (var row = 0; row < rowsNotSelected.length; row++) {
				rowsNotSelected[row].style.backgroundColor = "";
				rowsNotSelected[row].style.color = "#404040";
				rowsNotSelected[row].classList.remove('selected');
			}
			var rowSelected = tableRow.getElementsByTagName('tr')[index];
			rowSelected.style.backgroundColor = '#003d79';
			rowSelected.style.color = "#FFFFFF";
			rowSelected.className += 'selected';

			// font resizing on uprights
			$('#fitin div').css('font-size', '1em');
			
			while( $('#fitin div').height() > $('#fitin').height() ) {
				$('#fitin div').css('font-size', (parseInt($('#fitin div').css('font-size')) - 1) + "px" );
			}

			$('.donor div').css('font-size', '1em');
			
			while( $('.donor div').height() > $('.donor').height() ) {
				$('.donor div').css('font-size', (parseInt($('.donor div').css('font-size')) - 1) + "px" );
			}

			$('.title div').css('font-size', '1em');
			
			while( $('.title div').height() > $('.title').height() ) {
				$('.title div').css('font-size', (parseInt($('.title div').css('font-size')) - 1) + "px" );
			}
		}

		// color picker
		var myCP;
		function doOnLoad() {
			myCP = new dhtmlXColorPicker({
				parent: "cpObj",
				custom_colors: ["#206cc2"],
				closeable: false
			});
			myCP.attachEvent("onChange", setColor);
		};
		
		function doOnUnload() {
			if (myCP != null) {
				myCP.unload();
				myCP = null;
			}
		};
		
		function setColor(color) {
			var ct = document.getElementById("colorType");
			var inp = document.getElementById("bg");
			var titleColor = document.getElementById("titleText");
			var secondary = document.querySelectorAll(".secondaryColor");
			var secondaryBorder = document.querySelector('#photoBorder');
			var mainTextColors = document.querySelectorAll('.mainTextColor');

			switch (ct.value) {
				case "text":
					mainTextColors.forEach(function(item) {
						item.style.color = color;
					});
					break;
				case "bg":
					inp.style.backgroundColor =  color;
					break;
				case "title":
					titleColor.style.color = color;
					break;
				case "secondary":
					secondary.forEach(function(item) {
						item.style.backgroundColor =  color;
					});
					secondaryBorder.style.border = `5px solid ${color}`;
					break;
			}
		};
		// color picker END

		function saveColors(x) {
			var index = x.parentNode.parentNode.rowIndex;
			var id = document.getElementById("tableRow").rows[index].cells[0].innerHTML;

			var bg = document.getElementById("bg");
			var bgColor = bg.style.backgroundColor;

			// localStorage.setItem(id, JSON.stringify({
			// 	id: id,
			// 	bgColor: bgColor
			// }));
			// console.log(JSON.parse(localStorage.getItem(id)));
			localStorage.clear();
		}

	</script>
	
  </head>

	<body onload="doOnLoad();" onunload="doOnUnload();">
		<%if(admin){%>
			<%- include('adminHeader') -%>
			<%}else{%>
				<%- include('header') -%>
		<%}%>
		<%if(admin == 0){%>
			<%- include('footerClock') -%>
		<%}%>

		<div class="container-fluid">
			<div class="row">
				<div class="col">
					<h2 class="my-4 ml-1">Package Upright <i class="fas fa-info-circle"></i></h2>
					<table class="table table-bordered table-sm summary-table mt-4" id="tableRow">
						<thead>
							<tr class="text-center">
								<th scope="col" class="narrow-col">#</th>
								<th scope="col" class="large-col">Name</th>
								<th scope="col" class="narrow-col">Category</th>
								<th class="large-col" scope="col">Actions</th>
								<th scope="col" class="hide">Image</th>
								<th scope="col" class="hide">Value</th>
								<th scope="col" class="hide">Description</th>
							</tr>
						</thead>
						<tbody>
							<% for (var i in packages){%>
		
								<tr class="packageRow" onclick="retrieveData(this)">
									<td><%= packages[i]._id%></td>
									<td><%=packages[i].name%></td>
									
									<td><%= packages[i].cat%></td>   
									
									<td class="text-center">
										<a href='/<%=auction%>/packages/edit/<%=packages[i]._id%>'><i class="fas fa-edit to-edit" title="Edit Package"></i></a>
										<a href='/<%=auction%>/packages/remove/<%=packages[i]._id%>'><i class="far fa-trash-alt to-delete" title="Delete Package"></i></a>
										<i class="far fa-save to-save" title="Save Color" onclick="saveColors(this)"></i>
										<i class="fas fa-external-link-alt to-pdf create_pdf" title="Open PDF"></i>
									</td>
									<td class="hide"><%= packages[i].photo%></td>
									<td class="hide">$<%=packages[i].value%></td>
									<td class="hide"><%= packages[i].description%></td>

								</tr>
								<%}%>
						</tbody>
					</table>

				</div>
				<div class="col mt-5">

					<form class="form mt-4 hidden">
						<div class="upright bg" id="bg">
		
							<div class="donor secondaryColor mainTextColor">
								<div class="resized-text">
									Donors: Mr. & Mrs. Jones, Larry Graham
								</div>
							</div>
		
							<div class="title" id="titleText">
								<div class="resized-text"></div>
							</div>
		
							<div class="image">
								<img class="flexible-photo" id="photoBorder" src="">
								
								<div class="packageId secondaryColor mainTextColor" id="packageId"></div>
		
								<div class="value secondaryColor mainTextColor"></div>
							</div>
		
							<div id="fitin" class="secondaryColor mainTextColor">
								<div class="resized-text"></div>
							</div>
						</div>
					</form>
				</div>
			
				<div class="col mt-5">
					<div class="mt-4">
						<h5>Edit Colors: </h5>
						<select id="colorType">
							<option value="bg">Background color</option>
							<option value="text">Text color</option>
							<option value="title">Title color</option>
							<option value="secondary">Secondary color</option>
						</select>
					</div>
			
					<div id="cpObj"></div>
					<!-- <input type="button" id="saveColors" onclick="saveColors()" value="Save This Upright Color Scheme"> -->
					<!-- <input type="button" id="create_pdf" value="Open PDF"> -->
				</div>
			</div>
		</div>
		
		<script>  
			(function () {  
				var  
					form = $('.form'),  
					cache_width = form.width(),  
					a4 = [400, 518];
			
				$('.create_pdf').on('click', function () {  
					$('body').scrollTop(0);  
					createPDF();  
				});  

				//create pdf  
				function createPDF() {  
					getCanvas().then(function (canvas) {  
						var  
							img = canvas.toDataURL("image/png"),  
							doc = new jsPDF({  
								unit: 'in',  
								format: [4.17, 5.4]
							});  
						doc.addImage(img, 'JPEG', 0, 0);  
						window.open(URL.createObjectURL(doc.output("blob")));
						form.width(cache_width);  
					});  
				}  
			
				// create canvas object  
				function getCanvas() {  
					form.width((a4[0] * 1.33333) - 80).css('max-width', 'none');  
					return html2canvas(form, {
						scale: 2,
						imageTimeout: 2000,  
						removeContainer: true  
					});  
				}  
			
			}());  
		</script>
	</body>
</html>