<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Package Show</title>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="/css/packageShow.css">

<script type='text/javascript'>

	var socket = io.connect('http://localhost:8000/');
	// var socket = io.connect('http://dv1.elizabid.com/');

	$(document).ready(function () {

		$('#addWatchList').submit(function (event) {
			event.preventDefault();
			$.get("/<%= auction %>/users/interested-in-package/<%= package._id %>", function (data, status) {
				$("#addWatchList").replaceWith("<form id='removeWatchList' action='/<%= auction %>/users/uninterested-in-package/<%= package._id %>' method='GET'><input class='btn' type='submit' value='Remove from Watch List'></form>");
			});
		})

		$('#removeWatchList').submit(function (event) {
			event.preventDefault();
			$.get("/<%= auction %>/users/uninterested-in-package/<%= package._id %>", function (data, status) {
				$("#removeWatchList").replaceWith("<form id='addWatchList' action='/<%= auction %>/users/interested-in-package/<%= package._id %>' method='GET'><input class='btn' type='submit' value='Add to Watch List'></form>");
			});
		})

		// no bids and no value entered in bid form field
		$('#submitButton').submit(function (event) {
			event.preventDefault();
			let sendBid;
			let bidAmt = parseInt($("#bidAmount").val());
			let packageAmt = <%= package.amount %>;
			let newBid = parseInt(<%= lastBid + package.bidIncrement %>);
			let hiddenBidAmt = parseInt($("#hiddenBidAmt").val());
			let hasBids = <%= ourBids %>;
			let userName = "<%= user.firstName + ' ' + user.lastName %>";
			
			//No input and no bids, "Place Bid" will place bid of current bid plus increment
			if ( !bidAmt && hasBids === false ) {
				sendBid = packageAmt;
			//No input and has bids, "Place Bid" will place bid of current bid plus increment
			} else if ( !bidAmt && hasBids === true ) {
				//No hidden big amount use newBid from Controller else use the hidden bid amount from Server
				if (!hiddenBidAmt) {
					sendBid = newBid;
				} else {
					sendBid = hiddenBidAmt;
				}
			// no bids but with value entered in bid form field
			} else if ( bidAmt >= packageAmt && hasBids === false ) {
				sendBid = bidAmt;
			// has bids and has value entered in bid form field
			} else if ( bidAmt >= newBid && hasBids === true ) {
				sendBid = bidAmt;
			}
			socket.emit('msgSent', { packId: '<%= package._id %>', bid: sendBid , userName: userName, name: '<%= package.name %>'})
		});
		// Updates packageShow page with bid price
		socket.on("serverTalksBack", function (data) {
			// console.log("200 packageShow.ejs socket.on serverTalksBack.  data = ",data);
			let currentBid = (data.lastBid).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
			let topBidder = data.userBidLast;
			let newBid = parseInt(data.lastBid) + <%= package.bidIncrement %>;
			let packageId = <%= package._id %>;
			let packId = parseInt(data.packId);

			if ( packId == packageId ) {
				$('#currentBid').text("Current Bid: $" + currentBid);
				$('#topBidder').text("Top Bidder: " + topBidder);
				$('#minBid').text("Bid $"+ newBid.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")+" or more");
				$('#bidAmount').attr('min',newBid);
				$('#bidAmount').val(newBid);
				$('#hiddenBidAmt').val(newBid);
				$('#afterBidMessage').text('');
				$('#history tr:first').after('<tr><td>'+ data.userBidLast+'</td><td>'+"$"+data.lastBid+'</td><td>'+data.bidTime+'</td></tr>');
				// console.log("210 packageShow.ejs socket.on serverTalksBack.  $('#hiddenBidAmt').val() = ",$('#hiddenBidAmt').val());
			}
		});

		//Updates submit button only after bidding has been saved in database 
		socket.on('buttonStateChannel', function (data) {
			if ( data.packId == <%= package._id %> ) {
				if( data.button == 'disabled' ){
					$('#submitButton2').attr('disabled','disabled')
				} else {
					$("#submitButton2").removeAttr('disabled');
				}
			}
		});
	})
	</script>
</head>

<body>

	<% if(admin){ %>
		<%- include('adminHeader') -%>
	<% } else { %>
		<%- include('header') -%>
	<% } %>
	<!-- <% if(admin == 0){ %>
	<%- include('footerClock') -%>
	<% } %> -->

	<div class="card">
		<div>
			<h3 class="card-header"><%= package.name %> </h3>
			<div>
				<img class="w-50 h-50" src="/<%= package.photo %>">
			</div>

			<div class="card-body">

				<p>Package Value: $<%= package.amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %></p>
				<p>Bid Increment: $<%= package.bidIncrement.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %></p>

				<% if(package.bids.length === 0){ %>
					<p id='topBidder'>Top Bidder: </p>
				<% }else{ %>
					<p id = 'topBidder'>Top Bidder: <%= package.bids[package.bids.length - 1].name %></p>
				<% } %>

				<% if (package.bids.length === 0){ %>
					<p id='currentBid'> Starting Bid: <%= "$" + package.amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %></p>
				<% }else{ %>
					<p id='currentBid'>Current Bid: $<%= lastBid.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %></p>
				<% } %>

				<!-- Placing Bids -->
				<% if (!admin){ %>
					<form class="mt-2" id='submitButton' class="w-50">
						<% if (package.bids.length === 0){ %>
							<input type="number" id='bidAmount' type="number" min='<%= package.amount %>' value='<%= package.amount%>'>
						<% }else{ %>
							<input type="number" id='bidAmount' type="number" min='<%= lastBid + package.bidIncrement %>' value='<%= lastBid + package.bidIncrement %>'>
						<% } %>
							<input id='hiddenBidAmt' type="hidden" value=''>
							<input class="ml-2 btn" type='submit' value='Place Bid' id='submitButton2'>
					</form>
				<% } %>

				<% if (package.bids.length === 0){ %>
					<p id = 'minBid'>Bid $<%= package.amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> or more</p>
				<% }else{ %>
					<p id ='minBid'>Bid $<%= (package.bidIncrement + lastBid).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") %> or more </p>
				<% } %>

				<!-- Buttons -->
				<!-- <p class="text-success" id="addSuccess"></p>
				<p class="text-success" id="removeSuccess"></p> -->

				<% if (user._packages.length > 0) { %>
					<form class = "d-inline" id="removeWatchList" action="/<%= auction %>/packages/<%= package._id %>" method='GET'>
						<input class="btn" type='submit' value='Remove from Watch List'>
					</form>
				<% } else { %>
					<form class = "d-inline" id="addWatchList" action="/<%= auction %>/packages/<%= package._id %>" method='GET'>
						<input class="btn" type='submit' value='Add to Watch List'>
					</form>
				<% } %>
				
				<!-- Button trigger modal -->
				<button type="button" class="d-inline btn" data-toggle="modal" data-target="#exampleModalLong">Bid History</button>

				<div class = "ml-1 row">
					<a href="/<%= auction %>/packages"><button type="button" class="mt-2 btn" name="interested">Back</button></a>
					<a href="/<%= auction %>/packages/<%= prevPos %>"><button type="button" class="mt-2 ml-2 btn" name="interested">Previous</button></a>
					<a href="/<%= auction %>/packages/<%= nextPos %>"><button type="button" class="mt-2 ml-2 btn" name="interested">Next</button></a>
				</div>

				<p class = "mt-2">Description: <%= package.description %> </p>
				<p>Restriction(s): <%= package.restrictions %> </p>

				<!-- Modal -->
				<div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered" role="document">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="exampleModalLongTitle">Bid History</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
								</button>
							</div>
							<div class="modal-body">
								<p>Bidders: <strong><%= [...new Set(package.bids.map(x => x.name))].length; %></strong>&nbsp&nbsp&nbsp Bids: <strong><%= package.bids.length %></strong>&nbsp&nbsp&nbsp Time Left: &nbsp&nbsp&nbsp Duration:</p>

								<% if( package.bids.length === 0){ %>
									<p id ="afterBidMessage">No one has bid on this package yet.</p>

									<div class="mh-200">
											<table id = "history">
												<tr>
													<th>Bidder</th>
													<th>BidAmount</th>
													<th>Bid Time</th>
												</tr>
											<% for (var i = package.bids.length-1; i > -1; i--){ %>
												<tr>
													<td><%= package.bids[i].name %></td>
													<td><%= package.bids[i].bidAmount %></td>
													<td><%= package.bids[i].bidTime %></td>
												</tr>
											<% } %>
											</table>
										</div>

								<% }else{ %>

									<div class="mh-200">
										<table id = "history">
											<tr>
												<th>Bidder</th>
												<th>BidAmount</th>
												<th>Bid Time</th>
											</tr>
										<% for (var i = package.bids.length-1; i > -1; i--){ %>
											<tr>
												<td><%= package.bids[i].name %></td>
												<td>$<%= package.bids[i].bidAmount %></td>
												<td><%= package.bids[i].bidTime %></td>
											</tr>
										<% } %>
										</table>
									</div>
								<% } %>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>