<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Watch List</title>
  </head>
  <script  src="https://code.jquery.com/jquery-3.4.0.min.js"   integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="   crossorigin="anonymous"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.6.0/Sortable.js"></script>
 
  <!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="/css/style.css"> 
  <link rel="stylesheet" type="text/css" href="/css/packageStyleWatchlist.css"> 

  <body>
    <%if(admin == 2){%>
    <%- include('adminHeader') -%>
    <%}else{%>
      <%- include('header') -%>
  <%}%>
  <% if(admin == 0){ %>
		<%- include('footerNotifications') %>
		<%- include('footerClock') -%>
	<%}%>
    <div class="container margin-tofooter">
      <h2 class="supporter-view">My Watch List</h2>

      <!-- <div class="row text-center">
        <i class="fas fa-check-circle">High Bid</i>
        <i class="fas fa-exclamation-circle">Outbid</i>
        <i class="fas fa-times-circle">Unavailable</i>
      </div> -->

     
      <!-- <div class="d-flex flex-row flex-wrap justify-content-start mt-2">
        <div class="col-lg-4 col-md-12 col-sm-12 mb-3">
          <input type="search" id="keyword" class="form-control search-pkg" placeholder="Search Packages">
        </div>

        <div class="col-lg-4 col-md-12 col-sm-12 mb-3">
          <select name="category" id="category" class="form-control search-inner search-pkg">
            <option value="">All Categories</option>
              <% for(var c in categories) {%>
                <option value="<%=categories[c].name%>"><%=categories[c].name%></option>
              <%}%>
          </select>
        </div>

        <div class="col-lg-4 col-md-12 col-sm-12 mb-3">	
          <button class="form-control btn-no-bids" id="noBids" name="button">Packages with No Bids</button>
        </div>
      </div>  -->

      <div class="d-flex flex-row flex-wrap justify-content-start">
      <%for(let i =0; i<user._packages.length; i++){%>
        <% let currentPackage = user._packages[i] %>
        
        <% console.log("userPage.ejs***********currentPackage)\n" +currentPackage) %>
        
        <%if(currentPackage.bids.length>0){%>
          <div class="package bids col-lg-4 col-md-12 col-sm-12 " id="removeWatchList-<%= currentPackage._id %>">
        <%}else{%>
          <div class="package no-bids col-lg-4 col-md-12 col-sm-12 " id="removeWatchList-<%= currentPackage._id %>">
        <%}%>

        <div id="<%=currentPackage._id %>" class="card pkg-card">	
          <div id="selection" class="card-body">
            <div class="row">
              <div class="col-8">
                  <div class="row">
                      <div class="col-2">
                          <span class="pkg-num">
                              #<%=currentPackage.id%>
                          </span>
                      </div>
                      <div class="col-10">
                        <h4><a class="pkg-title" href="/<%=auction%>/packages/<%=currentPackage._id%>"><%=currentPackage.name%></a>
                        </h4>
                      </div>
                    </div>
                  <div class="row">
                      <div class=" col-2">
                          <img class="pkg-img mr-3" src="/<%=currentPackage.photo %>">
                      </div>
                      <div class=" col-6">
                          <ul class="mt-1">	
                            <li>Value: <span class="opening-bid"> <%="$" + currentPackage.value%></span> &nbsp;&nbsp;
                            <%if(currentPackage.bids.length === 0){%>
                              <li class="no-bid">No bids yet! </li>
                            <%}else{%>
                              <li>Highest Bid: <span id="highest-bid-<%= currentPackage._id%>" class="highest-bid"><%="$" + currentPackage.bids[currentPackage.bids.length-1].bidAmount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")%></span>
                              <span class="highest-bid">(by: <span id="highest-bidder-<%= currentPackage._id%>"> <%= currentPackage.bids[currentPackage.bids.length-1].name%></span>)</span>
                              </li>
                            <%}%>
                            <li>Your Last Bid:</li>
                            </ul>
                      </div>
                  </div>
              </div>
              <div class="col-4">
                  <form class="bidForm" id='submitButton' class="w-50" name="<%=i%>">
                      <input type="hidden" name="highBid" value='<%=currentPackage.highBid %>'>
                      <input type="hidden" name="bidIncrement" value='<%=currentPackage.bidIncrement %>'>
                      <input type="hidden" name="packageId" value='<%=currentPackage.id %>'>
                      <input type="hidden" name="packageName" value='<%=currentPackage.name %>'>
                      <input type="hidden" name="packageAmt" value='<%=currentPackage.amount %>'>
                      <input type="hidden" name="allBids" value='<%=currentPackage.bids %>'>

                      <% let recommendedBid = (currentPackage.bids.length > 0) ? currentPackage.highBid + currentPackage.bidIncrement : currentPackage.amount%>
                      <input class="bid-input-field" type="number" id='bidAmount-<%= currentPackage._id%>' name="bidAmount" type="number" min='<%= recommendedBid %>' value='<%= recommendedBid%>' max='<%=secret.maxBid%>'>
                      <input id='hiddenBidAmt' type="hidden" value=''>
                      <input class="ml-1 btn-bid" type='submit' value='Place Bid' id='bid-btn-<%=currentPackage.id%>'>
                  </form>
                  <div>
                    <button>
                      <a onClick="change(<%= currentPackage._id %>)" value="Remove from Watch List" id="watchlistButton-<%=currentPackage._id%>">Remove from Watchlist</a></div>
                    </button>
                </div>

            </div>
          </div>
        </div>
      </div>
    <%}%>
    </div> 
  </div> <!-- End of container -->

    <script>

      var socket = io.connect();

      function change(packageId) {
        var x = document.getElementById("removeWatchList-"+packageId);
        x.style.display = "none";
        $.get("/<%= auction %>/users/uninterested-in-package/"+packageId);
      }
        

      $(document).ready(function(){
        let auctionEndTime = Date.parse("<%= auctionDetails.endClock %>");
		    var date = new Date();
        if(date > auctionEndTime){
          $(".bid-btn").attr("disabled", "disabled")
        }else{
          let packages = <%-JSON.stringify(user._packages) %>;
          $.each(packages, function( index, p ) {
            let lastBid = p.bids[p.bids.length-1]
            
            if ("<%=user.firstName + ' ' + user.lastName%>" === p.highBidder || p.highBid >= <%=secret.maxBid%>){
              $(`#bid-btn-${p._id}`).attr("disabled", "disabled")
            }
          });
        }
        
        $('.bidForm').submit(function (event) {
          event.preventDefault();
          // console.log($(this).serialize())
          let auction = "<%= auctionDetails._id %>";
          let userName = "<%= user.firstName + ' ' + user.lastName %>";
          // values(dictionary) maps all form inputs to values
          var $inputs = $('.bidForm :input');
          var values = {};
          $.each($(this).serializeArray(), function(i, field) {
            values[field.name] = field.value;
          });
          // $inputs.each(function() {
          //     values[this.name] = this.value
          // });

          console.log(values)
          console.log('userPage.ejs ~~~~~~~~~')
          let hasBids = (values.allBids.length > 0)
          // if(values.allBids.length != 0){
          //   hasBids = true
          // } else {
          //   hasBids = false
          // }

          let packageAmt = parseInt(values.packageAmt)
          let sendBid;
          let hiddenBidAmt = parseInt($("#hiddenBidAmt").val());
          let bidAmt = parseInt(values.bidAmount)
          let newBid = parseInt(values.bidIncrement) + parseInt(values.highBid)

          //No input and no bids, "Place Bid" will place bid of current bid plus increment
          if ( !bidAmt && hasBids === false ) {
            sendBid = packageAmt;
          //No input and has bids, "Place Bid" will place bid of current bid plus increment
          } else if ( !bidAmt && hasBids === true ) {
            //No hidden big amount use newBid from Controller else use the hidden bid amount from Server
            if (!hiddenBidAmt) {
              sendBid = newBid;
            } else {
              sendBid = hiddenBidAmt;
            }
          // no bids but with value entered in bid form field
          } else if ( bidAmt >= packageAmt && hasBids === false ) {
            sendBid = bidAmt;
          // has bids and has value entered in bid form field
          } else if ( bidAmt >= newBid && hasBids === true ) {
            sendBid = bidAmt;
          }

            let msgSent = {
              packId: values.packageId,
              bid: sendBid,
              userName: userName,
              name: values.packageName,
              auction:auction,
            }
            console.log("userPage.ejs********************msgSent***************\n" +msgSent)
            socket.emit('msgSent', msgSent)
          });

        $("select[name='category']").change( function() {
          var value = $(this).val().toLowerCase();
          $(".package").filter(function(){
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
          })
        });

        $('#update').click(function(){
          var result = sortable.toArray()
          console.log(result)
          $.ajax({type: 'GET',
            url:'/<%=auction%>/users/updateList/' + result + '/' + userId
          })
        })

        $("#noBids").click(function() {
          $(".bids").toggle();
          $(this).text($(this).text() == 'Show All Packages' ? 'Packages with No Bids' : 'Show All Packages')
        });

        $("#keyword").on("keyup", function() {
          var value = $(this).val().toLowerCase();
          $(".package").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });

         // Update highest bidder and bid amount
        socket.on("serverTalksBack", function (data) {
          // FIXME: it doesn't update the first bid from no bids yet to highest bid
          // console.log('inside servertalkback', data)
          let currentBid = (data.lastBid).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          let topBidder = data.userBidLast;
          let newBid = data.lastBid + data.bidIncrement

          $(`#highest-bid-${data.packId}`).text("$"+ currentBid);
          $(`#highest-bidder-${data.packId}`).text(data.userBidLast);
          // NEED BID INCREMENT
          let bidAmountInput = $(`#bidAmount-${data.packId}`)
          bidAmountInput.val(newBid);
          bidAmountInput.attr('min',data.lastBid+data.bidIncrement);
          }
          // $('#bidAmount-'+data.packId).val()
        );

        		//Updates submit button only after bidding has been saved in database
        socket.on('buttonStateChannel', function (data) {
            let btn = $(`#bid-btn-${data.packId}`);
            if( data.button === 'disabled'){
              btn.attr('disabled','disabled')
            } else {
              if("<%= user.firstName + " " + user.lastName%>" !== data.lastBidder){
                btn.removeAttr('disabled');
              }
            }
        });

        

      })
    </script>
    
    <!-- <script>
    	var socket = io.connect('http://localhost:8000/');
      var cartTotal = <%=cartTotal%>
      var userId = '<%= user._id%>';
      var el = document.getElementById('selections')
      var sortable = Sortable.create(el)
        
      socket.on("serverTalksBack", function(data){
        let currentBid = (data.lastBid).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        var isDone = false;

        <%for (var j = 0; j < user._packages.length; j++){%>
          if(<%=user._packages[j]._id%> == data.packId){
            // if(data.userName === "<%=userName%>"){
            if(data.userName === userName){
              console.log("data.userName = ", data.userName)
              console.log("userName = ", userName)
              $("#highest-bid-<%=user._packages[j]._id%>").text("$"+currentBid);cd 
              $("#<%=user._packages[j]._id%>").text(data.userName)
            }
          }
          else if(data.userName === "<%=userName%>" && <%=j%> === <%=user._packages.length - 1%>){
            isDone = true
          }
        <%}%>

        //This below code only runs if the user has bid on a package that they had not previously had on their watchlist
        if(isDone){
          $("#selections").append(`
            <tr data-id= data.packId class='selection' style='cursor: move'>
            <td><a href="/<%=auction%>/packages/"` + data.packId + `">` + data.name + `</a></td>
            <td id = "` + data.packId + `">You!!!</td>

            <td><a href="/<%=auction%>/users/uninterested/data.packId"><button type="button" name="uninterested">Remove from Watchlist</button></a></td>
            </tr>`
          )
          //Needs to add an entire new row to the table
        }
        <%for (var j = 0; j < cartArray.length; j++){%>
          if(<%=cartArray[j]._id%> == data.packId){
            cartTotal -= <%=cartArray[j].bids[cartArray[j].bids.length - 1].bidAmount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")%>
            $("#cartTotal").text("Total: $" + cartTotal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","))
            //Remove your last bid amount from cartTotal
          }
          //If the newest bidder is you, then you will add the new amount to cartTotal
        <%}%>
      })
    </script> -->
  </body>
</html>
